Here’s a draft `.md` you can drop into the repo (e.g. `docs/excel_exports.md` or similar).

---

# Excel Exports – PS English Notes

Working notes for building Excel (`.xlsx`) exports in the PS English Credit Portal, with a focus on the **teacher invoice** download route:

`app/(admin)/admin/teachers/[teacherId]/invoices/[invoiceId]/download/route.ts`

These notes are mainly here to save future devs (and future AI helpers) from re-learning the same gotchas.

---

## 1. Niggly technical issues (Buffer, ExcelJS, Next.js)

### 1.1 ExcelJS + `Buffer` typing mismatch

* We use **ExcelJS** in a **Node** route (`export const runtime = "nodejs"`).

* Images are added with:

  ```ts
  const logoId = workbook.addImage(
    {
      buffer: logoBuffer,
      extension: "png",
    } as any, // IMPORTANT: cast to any to silence TS
  );
  ```

* The logo buffer comes from `fs.readFileSync`:

  ```ts
  let invoiceLogoBufferCache: Buffer | null = null;

  function getInvoiceLogoBuffer(): Buffer | null {
    if (invoiceLogoBufferCache) return invoiceLogoBufferCache;

    try {
      const logoPath = path.join(
        process.cwd(),
        "public",
        "brand",
        "PSEnglish_logo.png",
      );

      const fileBuffer = fs.readFileSync(logoPath);
      invoiceLogoBufferCache = fileBuffer;
      return invoiceLogoBufferCache;
    } catch (error) {
      console.error("Invoice logo not found or could not be read:", error);
      return null;
    }
  }
  ```

* **Why the `as any`?**

  * ExcelJS’ `Image` type expects a different `Buffer` shape than `fs.readFileSync`’s `Buffer<ArrayBufferLike>`.

  * TypeScript complains with errors like:

    > Type 'Buffer<ArrayBufferLike>' is missing the following properties from type 'Buffer': maxByteLength, resizable, resize, detached, …

  * At runtime, Node’s `Buffer` works perfectly with ExcelJS; this is purely a typing mismatch.

  * The cast to `as any` is an intentional, localized escape hatch to keep the rest of the file type-safe.

**Rule of thumb:**
If you add more images, use the same pattern:

```ts
workbook.addImage({ buffer: someBuffer, extension: "png" } as any);
```

and keep image loading in Node (not in edge runtimes).

---

### 1.2 Runtime + route params (Next.js app router)

* This route **must** run in Node:

  ```ts
  export const runtime = "nodejs";
  export const dynamic = "force-dynamic";
  ```

* In the app router, `params` in route handlers are **async**:

  ```ts
  interface RouteContext {
    params: Promise<{ teacherId: string; invoiceId: string }>;
  }

  export async function GET(_req: NextRequest, { params }: RouteContext) {
    const { teacherId, invoiceId } = await params;
    // ...
  }
  ```

* Accessing `params.teacherId` synchronously will blow up with the “params is a Promise” Next.js error.

**Rule of thumb:**
Always `await params` in route handlers that use dynamic segments.

---

## 2. Top section layout requirements (Teacher Invoice XLSX)

These are **design requirements** for the top band of the teacher invoice export.

### 2.1 Columns and sheet span

* The invoice is designed to use **columns A–F**.
* Columns **G and beyond are intentionally unused** (no data placed there by default).

### 2.2 Fixed column widths

We set deterministic widths for A–F:

```ts
sheet.getColumn(1).width = 28; // A
sheet.getColumn(2).width = 15; // B
sheet.getColumn(3).width = 13; // C
sheet.getColumn(4).width = 24; // D
sheet.getColumn(5).width = 11; // E
sheet.getColumn(6).width = 20; // F
```

These are tuned for:

* A: labels / student names / section titles
* B: hours (numeric, 0.00 format)
* C: money (total per student)
* D–F: wider descriptive fields and header text

We **do not** auto-fit these columns (to avoid warping the logo).

---

### 2.3 Company address (top-left)

* The address is placed in **A1–A8**, left-justified, one line per row:

  ```ts
  const addressLines = [
    "PS English Limited",
    "37 Abbots Gardens",
    "London, N2 OJG",
    "UNITED KINGDOM",
    "+44 20 8248 7985",
    "+44 7855 507 779",
    "ask@psenglish.co.uk",
    "www.psenglish.co.uk",
  ];

  addressLines.forEach((line, index) => {
    const rowNumber = 1 + index; // rows 1–8
    const cell = sheet.getCell(`A${rowNumber}`);
    cell.value = line;
    cell.font = { size: 10 };
    cell.alignment = { horizontal: "left", vertical: "middle" };
  });
  ```

* No merges, no bold; simple block of text at the top left.

---

### 2.4 Logo (top-right)

* Logo file:
  `public/brand/PSEnglish_logo.png`
* Placed in **F1–F5**:

  ```ts
  const logoBuffer = getInvoiceLogoBuffer();
  if (logoBuffer) {
    const logoId = workbook.addImage(
      {
        buffer: logoBuffer,
        extension: "png",
      } as any,
    );

    // Logo top right
    sheet.addImage(logoId, "F1:F5");
  }
  ```

Notes:

* The logo scales to fill the rectangle F1–F5.
* If you change this range (e.g. `F1:F4` or `E1:F6`), you change the **size** and **position**.
* Because we fix column widths and avoid auto-fitting columns A–F, the logo is **not** stretched by later content.

---

### 2.5 Header text (top-right below logo)

* Header lines:

  * F6 = `PS English`
  * F7 = `Teacher Invoice`
  * F8 = `${teacherLabel} · ${monthLabel}` (e.g. `Teacher One · October 2025`)

* All right-justified:

  ```ts
  sheet.getCell("F6").value = "PS English";
  sheet.getCell("F7").value = "Teacher Invoice";
  sheet.getCell("F8").value = `${teacherLabel} · ${monthLabel}`;

  ["F6", "F7", "F8"].forEach((addr) => {
    const cell = sheet.getCell(addr);
    cell.alignment = { horizontal: "right", vertical: "middle" };
  });

  sheet.getCell("F6").font = { size: 14, bold: true };
  sheet.getCell("F7").font = { size: 12, bold: true };
  sheet.getCell("F8").font = { size: 11 };
  ```

* There is **no invoice meta block** on the sheet (no ID, ref, status, created/paid). That information exists in the DB / filename, not in the document header.

---

## 3. Column width strategy

General rules derived from the invoice export:

1. **Columns with images must not be auto-fitted**

   * Auto-fitting a column that hosts an image (e.g. A–F here) can stretch or shrink the image unexpectedly.
   * We fix widths for A–F and only auto-fit **beyond** those.

2. **Numeric columns can be narrower**

   * Hours (e.g. `0.00`) work fine around width 10–12.
   * Money formatted as `£#,##0.00` is usually fine around 12–14.

3. **Label / name columns need breathing space**

   * Section headers (“Invoice totals”, “Per-student breakdown (invoice month)”) and student names get a wider column (e.g. 24–28).

4. **Auto-fit only for “tail” columns**
   The current pattern:

   ```ts
   sheet.columns?.forEach((col, index) => {
     if (!col) return;
     const colNumber = index + 1;

     // Skip A–F to keep header/logo stable
     if (colNumber <= 6) {
       return;
     }

     let maxLength = 10;
     col.eachCell?.({ includeEmpty: true }, (cell) => {
       const cellValue = cell.value;
       const str = cellValue ? String(cellValue) : "";
       maxLength = Math.max(maxLength, str.length + 2);
     });
     col.width = maxLength;
   });
   ```

   For the teacher invoice, G+ are unused, but this pattern is good if a future export uses more columns.

---

## 4. Data layout: starting rows and sections

### 4.1 Start of “core” invoice data

* All the top “branding” is in rows 1–10.

* **Invoice data** starts at **row 11**:

  ```ts
  let rowIndex = 11;

  sheet.getCell(`A${rowIndex}`).value = "Invoice totals";
  sheet.getCell(`A${rowIndex}`).font = { bold: true };
  rowIndex += 1;
  ```

* Adjusting `rowIndex` here is the main way to move the entire data block up/down without touching the top band.

### 4.2 Section structure

1. **Invoice totals** (compact table, A/B)

   * “Label” + “Value (hours / £)”
   * Hours and money formatted appropriately (`0.00` / money format string).

2. **Per-student breakdown** (A–C)

   * Headers: `Student`, `Hours`, `Total (£)`
   * Data rows:

     * A: full student name (via `v_student_names`) or raw student ID
     * B: hours (`minutes / 60`, `0.00`)
     * C: money (`pennies / 100`, money format)
   * Final totals row with Excel `SUM` formulas.

3. **Expenses detail** (A–F)

   * Headers: `Date`, `Student`, `Category`, `Description`, `Amount (£)`, `Status`
   * Values formatted with date string (London time) and money format.

### 4.3 No freeze panes

* We explicitly **removed** the `sheet.views` freeze line (no frozen rows or columns).
* If a freeze is reintroduced later, it should align with the row before “Invoice totals”, e.g.:

  ```ts
  // Optional: if needed in future
  sheet.views = [{ state: "frozen", xSplit: 0, ySplit: 10 }];
  ```

---

## 5. General advice for future Excel docs in this project

If you (or another AI helper) are building more Excel exports (e.g. student data multi-sheet, admin CSV-like dumps), here are some patterns to follow:

1. **Keep business logic and layout separate**

   * First: query Supabase, compute all necessary **numbers** (minutes → hours, pennies → pounds) and structures in TS.
   * Then: in a clearly separated “render to Excel” section, worry about:

     * column widths
     * fonts / styles
     * image placement
     * section headings

2. **Stick to the same branding band**

   * For consistency, reuse:

     * A1–A8 address block
     * logo in F1–F5
     * header text in F6–F8
   * Only change the middle header line (e.g. “Student export”, “Credit statement”, “Lesson summary”).

3. **Be cautious with auto-sizing**

   * Never auto-fit columns that contain images.
   * Prefer fixed widths for the primary data columns; use auto-fit only for “extra” columns away from the logo.

4. **Be explicit about units**

   * Hours = `minutes / 60` with `0.00` format.
   * Money = `pennies / 100` with `£#,##0.00;[Red]-£#,##0.00` format.
   * Always keep the DB → UI unit rules consistent with the rest of the app.

5. **Graceful failure on logo / images**

   * Make sure `getInvoiceLogoBuffer` can fail without breaking the export.
   * Log an error, but don’t throw—Excel export should still work without a logo.

6. **Filename semantics**

   * Current pattern for teacher invoices:

     ```ts
     const fileName = `teacherinvoice-${month_start}-${fileNameSafeTeacher}.xlsx`;
     ```

   * `fileNameSafeTeacher` is a slug of the teacher’s full name; follow a similar kebab-case slug pattern for other exports (`studentstatement-`, `creditsnapshot-`, etc.).

---

These notes are meant as the “Excel exports house style” for PS English.
If a future helper is building a new `.xlsx` route, they should refer back here, especially for:

* **Buffer / ExcelJS quirks**
* **Top band layout (address + logo + header)**
* **Column width and auto-fit decisions**
